/**
 * Retrieves the translation of text.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/packages/packages-i18n/
 */
import { __ } from '@wordpress/i18n';

/**
 * React hook that is used to mark the block wrapper element.
 * It provides all the necessary props like the class name.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/packages/packages-block-editor/#useblockprops
 */
import {
	useBlockProps,
	InspectorControls,
	RichText,
	MediaUpload,
	MediaUploadCheck
} from '@wordpress/block-editor';

import {
	PanelBody,
	TextControl,
	SelectControl,
	ToggleControl,
	Button,
	Dashicon,
	RangeControl,
	ColorPalette,
	__experimentalHStack as HStack,
	__experimentalVStack as VStack
} from '@wordpress/components';

import { useState } from '@wordpress/element';

/**
 * Lets webpack process CSS, SASS or SCSS files referenced in JavaScript files.
 * Those files can contain any CSS code that gets applied to the editor.
 *
 * @see https://www.npmjs.com/package/@wordpress/scripts#using-css
 */
import './editor.scss';

/**
 * The edit function describes the structure of your block in the context of the
 * editor. This represents what the editor will render when the block is used.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/block-api/block-edit-save/#edit
 *
 * @return {Element} Element to render.
 */
export default function Edit( { attributes, setAttributes } ) {
	const {
		tabs,
		layout,
		enableUrlHash,
		titleColor,
		titleActiveColor,
		titleBgColor,
		titleActiveBgColor,
		titleBorderColor,
		titleActiveBorderColor,
		contentColor,
		contentBgColor,
		contentBorderColor,
		iconColor,
		iconActiveColor,
		iconSize,
		titleAlignment
	} = attributes;

	const [ activeTab, setActiveTab ] = useState( 0 );

	const blockProps = useBlockProps(
		{
			className: `advanced-tabs-block layout-${layout}`
		}
	);

	/**
	 * Updates a specific field of a tab at the given index
	 *
	 * @param {number} index - The index of the tab to update
	 * @param {string} field - The field name to update (title, content, etc.)
	 * @param {any} value - The new value for the field
	 */
	const updateTab = ( index, field, value ) => {
		const newTabs = [ ...tabs ];
		newTabs[ index ][ field ] = value;
		setAttributes( { tabs: newTabs } );
	};

	const addTab      = () => {
		const newTabs = [ ...tabs ];
		newTabs.push(
			{
				id: `tab-${Date.now()}`,
				title: `Tab ${tabs.length + 1}`,
				icon: '',
				content: 'New tab content',
				imageUrl: '',
				imageId: 0
			}
		);
		setAttributes( { tabs: newTabs } );
	};

	const removeTab   = ( index ) => {
		const newTabs = [ ...tabs ];
		newTabs.splice( index, 1 );
		setAttributes( { tabs: newTabs } );
		if ( activeTab >= newTabs.length ) {
			setActiveTab( Math.max( 0, newTabs.length - 1 ) );
		}
	};

	const moveTab      = ( index, direction ) => {
		const newTabs  = [ ...tabs ];
		const newIndex = index + direction;
		if ( newIndex >= 0 && newIndex < newTabs.length ) {
			[ newTabs[ index ], newTabs[ newIndex ] ] = [ newTabs[ newIndex ], newTabs[ index ] ];
			setAttributes( { tabs: newTabs } );
			setActiveTab( newIndex );
		}
	};

	const colors = [
		{ name: 'Black', color: '#000000' },
		{ name: 'White', color: '#ffffff' },
		{ name: 'Red', color: '#ff0000' },
		{ name: 'Green', color: '#00ff00' },
		{ name: 'Blue', color: '#0000ff' },
		{ name: 'Yellow', color: '#ffff00' },
		{ name: 'Gray', color: '#cccccc' }
	];

	return (
		<>
			<InspectorControls>
				<PanelBody title={__( 'Tab Settings', 'advanced-tabs-block' )} initialOpen={true}>
					< SelectControl
						label     = { __( 'Layout', 'advanced-tabs-block' ) }
						value     = { layout }
						options   = { [
							{ label: __( 'Horizontal', 'advanced-tabs-block' ), value: 'horizontal' },
							{ label: __( 'Vertical', 'advanced-tabs-block' ), value: 'vertical' },
							{ label: __( 'Vertical Reverse', 'advanced-tabs-block' ), value: 'vertical-reverse' }
							] }
						onChange  = { ( value ) => setAttributes( { layout: value } ) }
					/ >
					< ToggleControl
						label     = { __( 'Enable URL Hash', 'advanced-tabs-block' ) }
						help      = { __( 'Allow direct linking to specific tabs via URL hash', 'advanced-tabs-block' ) }
						checked   = { enableUrlHash }
						onChange  = { ( value ) => setAttributes( { enableUrlHash: value } ) }
					/ >
				< / PanelBody >

				< PanelBody title                               = { __( 'Manage Tabs', 'advanced-tabs-block' ) } initialOpen = { false } >
					{ tabs.map(
						( tab, index ) => (
						< VStack key                            = { tab.id } spacing = { 2 } style = { { marginBottom: '20px', padding: '10px', border: '1px solid #ddd' } } >
							< HStack >
								< strong > { __( 'Tab', 'advanced-tabs-block' ) } { index + 1 } < / strong >
							< / HStack >
							< TextControl
								label                           = { __( 'Title', 'advanced-tabs-block' ) }
								value                           = { tab.title }
								onChange                        = { ( value ) => updateTab( index, 'title', value ) }
							/ >
							< TextControl
								label                           = { __( 'Dashicon Name', 'advanced-tabs-block' ) }
								help                            = { __( 'e.g., star-filled, admin-post, format-aside', 'advanced-tabs-block' ) }
								value                           = { tab.icon }
								onChange                        = { ( value ) => updateTab( index, 'icon', value ) }
							/ >
							< MediaUploadCheck >
								< MediaUpload
									onSelect                    = { ( media ) => {
										updateTab( index, 'imageUrl', media.url );
										updateTab( index, 'imageId', media.id );
										} }
									allowedTypes                = { [ 'image' ] }
									value                       = { tab.imageId }
									render                      = { ( { open } ) => (
										< >
											< Button onClick    = { open } variant = "secondary" style = { { textAlign: 'center', width: '100%' } } >
												{ tab.imageUrl ? __( 'Change Image', 'advanced-tabs-block' ) : __( 'Select Image', 'advanced-tabs-block' ) }
											< / Button >
											{ tab.imageUrl && (
												< >
													< img src   = { tab.imageUrl } alt = "" style = { { maxWidth: '100%', marginTop: '10px' } } / >
													< Button
														onClick = { () => {
															updateTab( index, 'imageUrl', '' );
															updateTab( index, 'imageId', 0 );
															} }
														variant = "link"
														isDestructive
														style   = { { textAlign: 'center', width: '100%' } }
													>
														{ __( 'Remove Image', 'advanced-tabs-block' ) }
													< / Button >
												< / >
											) }
										< / >
									) }
								/ >
							< / MediaUploadCheck >
							< VStack spacing        = { 1 } >
								< HStack spacing    = { 1 } >
									{ index > 0 && (
										< Button
											onClick = { () => moveTab( index, -1 ) }
											variant = "secondary"
											icon    = "arrow-up-alt2"
										>
											{ __( 'Move Up', 'advanced-tabs-block' ) }
										< / Button >
									) }
									{ index < tabs.length - 1 && (
										< Button
											onClick = { () => moveTab( index, 1 ) }
											variant = "secondary"
											icon    = "arrow-down-alt2"
										>
											{ __( 'Move Down', 'advanced-tabs-block' ) }
										< / Button >
									) }
								< / HStack >
								{ tabs.length > 1 && (
									< Button
										onClick = { () => removeTab( index ) }
										variant = "secondary"
										isDestructive
									>
										{ __( 'Remove', 'advanced-tabs-block' ) }
									< / Button >
								) }
							< / VStack >
							< / VStack >
						)
					) }
					< Button onClick = { addTab } variant = "primary" >
						{ __( 'Add Tab', 'advanced-tabs-block' ) }
					< / Button >
				< / PanelBody >

				< PanelBody title        = { __( 'Title Styling', 'advanced-tabs-block' ) } initialOpen = { false } >
					< VStack spacing     = { 3 } >
						< div >
							< p > { __( 'Normal Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { titleColor }
								onChange = { ( value ) => setAttributes( { titleColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Active Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { titleActiveColor }
								onChange = { ( value ) => setAttributes( { titleActiveColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Background Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { titleBgColor }
								onChange = { ( value ) => setAttributes( { titleBgColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Active Background', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { titleActiveBgColor }
								onChange = { ( value ) => setAttributes( { titleActiveBgColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Border Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { titleBorderColor }
								onChange = { ( value ) => setAttributes( { titleBorderColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Active Border Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { titleActiveBorderColor }
								onChange = { ( value ) => setAttributes( { titleActiveBorderColor: value } ) }
							/ >
						< / div >
						< SelectControl
							label        = { __( 'Text Alignment', 'advanced-tabs-block' ) }
							value        = { titleAlignment }
							options      = { [
								{ label: __( 'Left', 'advanced-tabs-block' ), value: 'left' },
								{ label: __( 'Center', 'advanced-tabs-block' ), value: 'center' },
								{ label: __( 'Right', 'advanced-tabs-block' ), value: 'right' }
								] }
							onChange     = { ( value ) => setAttributes( { titleAlignment: value } ) }
						/ >
					< / VStack >
				< / PanelBody >

				< PanelBody title        = { __( 'Icon Styling', 'advanced-tabs-block' ) } initialOpen = { false } >
					< VStack spacing     = { 3 } >
						< div >
							< p > { __( 'Icon Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { iconColor }
								onChange = { ( value ) => setAttributes( { iconColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Active Icon Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { iconActiveColor }
								onChange = { ( value ) => setAttributes( { iconActiveColor: value } ) }
							/ >
						< / div >
						< RangeControl
							label        = { __( 'Icon Size', 'advanced-tabs-block' ) }
							value        = { iconSize }
							onChange     = { ( value ) => setAttributes( { iconSize: value } ) }
							min          = { 12 }
							max          = { 48 }
						/ >
					< / VStack >
				< / PanelBody >

				< PanelBody title        = { __( 'Content Styling', 'advanced-tabs-block' ) } initialOpen = { false } >
					< VStack spacing     = { 3 } >
						< div >
							< p > { __( 'Text Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { contentColor }
								onChange = { ( value ) => setAttributes( { contentColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Background Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { contentBgColor }
								onChange = { ( value ) => setAttributes( { contentBgColor: value } ) }
							/ >
						< / div >
						< div >
							< p > { __( 'Border Color', 'advanced-tabs-block' ) } < / p >
							< ColorPalette
								colors   = { colors }
								value    = { contentBorderColor }
								onChange = { ( value ) => setAttributes( { contentBorderColor: value } ) }
							/ >
						< / div >
					< / VStack >
				< / PanelBody >

			< / InspectorControls >

			< div { ...blockProps } >
				< style >
					{ `
						.advanced - tabs - block .tab - title {
							${titleColor ? `color : ${titleColor};` : ''}
							${titleBgColor ? `background - color : ${titleBgColor};` : ''}
							${titleBorderColor ? `border - color : ${titleBorderColor};` : ''}
							text - align: ${titleAlignment};
						}
						.advanced - tabs - block .tab - title.active {
							${titleActiveColor ? `color : ${titleActiveColor};` : ''}
							${titleActiveBgColor ? `background - color : ${titleActiveBgColor};` : ''}
							${titleActiveBorderColor ? `border - color : ${titleActiveBorderColor};` : ''}
						}
						.advanced - tabs - block .tab - title .dashicon {
							${iconColor ? `color : ${iconColor};` : ''}
							font - size: ${iconSize}px;
						}
						.advanced - tabs - block .tab - title.active .dashicon {
							${iconActiveColor ? `color : ${iconActiveColor};` : ''}
						}
						.advanced - tabs - block .tab - content {
							${contentColor ? `color : ${contentColor};` : ''}
							${contentBgColor ? `background - color : ${contentBgColor};` : ''}
							${contentBorderColor ? `border - color : ${contentBorderColor};` : ''}
						}
						` }
				< / style >
				< div className                           = "tabs-header" >
					{ tabs.map(
						( tab, index ) => (
						< div
							key                           = { tab.id }
							className                     = { `tab - title ${index === activeTab ? 'active' : ''}` }
							onClick                       = { () => setActiveTab( index ) }
							role                          = "button"
							tabIndex                      = { 0 }
						>
							{ tab.icon && < Dashicon icon = { tab.icon } className = "dashicon" / > }
							< span > { tab.title } < / span >
						< / div >
						)
					) }
				< / div >
				< div className                 = "tab-content" >
					{ tabs[ activeTab ] && (
						< div className         = "tab-content-inner" >
							{ tabs[ activeTab ].imageUrl && (
								< div className = "tab-image" >
									< img src   = { tabs[ activeTab ].imageUrl } alt = { tabs[ activeTab ].title } / >
								< / div >
							) }
							< div className     = "tab-text" >
								< RichText
									tagName     = "div"
									value       = { tabs[ activeTab ].content }
									onChange    = { ( value ) => updateTab( activeTab, 'content', value ) }
									placeholder = { __( 'Add content...', 'advanced-tabs-block' ) }
								/ >
							< / div >
						< / div >
					) }
				< / div >
			< / div >
		< / >
	);
}
